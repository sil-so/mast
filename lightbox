(function () {
  "use strict";

  const CONFIG = {
    selector: '[data-stack="wrapper"]',
    itemSelector: '[data-stack="item"]',
    debug: true // Toggle this to false when done
  };

  function log(msg, data = '') {
    if (CONFIG.debug) console.log(`%c[StackDebug] ${msg}`, 'color: #00e5ff; font-weight: bold;', data);
  }

  function init() {
    log('Initializing...');

    // 1. Check if GLightbox is loaded
    if (typeof GLightbox === 'undefined') {
      console.error('[StackDebug] GLightbox is not defined. Waiting 500ms...');
      setTimeout(init, 500); // Retry if library is deferred
      return;
    }

    // 2. Find wrappers
    const stacks = document.querySelectorAll(CONFIG.selector);
    log(`Found ${stacks.length} stack wrappers.`);

    if (stacks.length === 0) {
      console.warn('[StackDebug] No elements found with data-stack="wrapper". Check your HTML attributes.');
      return;
    }

    stacks.forEach((stack, index) => {
      // 3. Find images (Scoped to the stack)
      // We look for images inside the items
      const images = stack.querySelectorAll(`${CONFIG.itemSelector} img`);
      
      log(`Stack #${index + 1}: Found ${images.length} images.`);

      if (images.length === 0) return;

      // 4. Build Gallery Data
      const galleryElements = Array.from(images).map((img, i) => {
        // Grab the largest image from srcset if available, or fallback to src
        // Note: currentSrc is the browser-chosen image (usually resized). 
        // For a lightbox, you usually want the full res. 
        // If you have the full res in a data attribute, use that. 
        // Otherwise, we use currentSrc.
        const src = img.currentSrc || img.src;
        return {
          href: src,
          type: 'image',
          alt: img.getAttribute('alt') || `Image ${i}`
        };
      });

      // 5. Inject Badge
      if (images.length > 1) {
        // Check if badge already exists to avoid duplicates on re-init
        if (!stack.querySelector('.stack-badge')) {
          const badge = document.createElement('div');
          badge.classList.add('stack-badge');
          badge.textContent = `+${images.length - 1}`;
          stack.appendChild(badge);
        }
      }

      // 6. Initialize GLightbox
      let lightboxInstance;
      try {
        lightboxInstance = GLightbox({
          elements: galleryElements,
          touchNavigation: true,
          loop: true,
          openEffect: 'subtle-zoom',
          closeEffect: 'subtle-zoom',
          cssEfects: { 'subtle-zoom': { in: 'subtle-zoomIn', out: 'subtle-zoomOut' } }
        });
        log(`Stack #${index + 1}: GLightbox instantiated.`);
      } catch (err) {
        console.error(`Stack #${index + 1}: GLightbox failed to init`, err);
      }

      // 7. Click Listener (The Robust Way)
      // We explicitly remove old listeners (cloning) to prevent duplicates if script runs twice
      const newStack = stack.cloneNode(true); 
      // NOTE: Cloning removes event listeners, but invalidates references. 
      // Since you are using static HTML, we can just replace the element.
      // BUT: If other scripts rely on references, this is risky. 
      // BETTER APPROACH: Just add the listener.
      
      stack.style.cursor = 'pointer'; // Visual feedback
      
      const clickHandler = (e) => {
        log(`Stack #${index + 1}: Click Event Triggered on`, e.target);
        
        // Prevent default browser behavior
        e.preventDefault();
        e.stopPropagation();

        if (lightboxInstance) {
          log(`Stack #${index + 1}: Opening Lightbox...`);
          lightboxInstance.open();
        } else {
          console.error(`Stack #${index + 1}: Lightbox instance is missing.`);
        }
      };

      stack.addEventListener('click', clickHandler);
      log(`Stack #${index + 1}: Click listener attached.`);
    });
  }

  // Run immediately if DOM is ready, otherwise wait
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    // If we are late (deferred), run now
    init();
  }
})();
